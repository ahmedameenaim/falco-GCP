- required_engine_version: 11

- required_plugin_versions:
  - name: auditlogs
    version: 0.5.0
  - name: json
    version: 0.3.0


- macro: is_binded_delta_to_public
  condition: al.bind.members in ("allAuthenticatedUsers", "allUsers")

- macro: is_gcs_service
  condition: al.service.name="storage.googleapis.com"

- macro: is_pubsub_service
  condition: al.service.name="pubsub.googleapis.com"

- macro: is_compute_service
  condition: al.service.name="compute.googleapis.com"

- macro: is_iam_service
  condition: al.service.name="iam.googleapis.com"

- macro: is_logging_service
  condition: al.service.name="logging.googleapis.com"

- macro: is_cloudsql_service
  condition: al.service.name="sqladmin.googleapis.com"

- macro: is_k8s_service
  condition: al.service.name="k8s.io"

- rule: GCP Cloud SQL database user modified
  desc: Detect when a Cloud SQL DB user has been modified.
  condition: is_cloudsql_service and al.method.name="cloudsql.users.update"
  output: A GCS bucket has been deleted by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, cloudsql, compliance]

- rule: GCP Cloud SQL database backup deleted
  desc: Detect when a Cloud SQL DB backup has been deleted.
  condition: is_cloudsql_service and al.method.name="cloudsql.backupRuns.delete"
  output: A Cloud SQL DB backup has been deleted by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, cloudsql, impact, T1490-inhibit-system-recovery]


- rule: GCP Cloud SQL database instance data exported
  desc: Detect when a Cloud SQL DB instance data to cloud storage bucket.
  condition: is_cloudsql_service and al.method.name="cloudsql.instances.export"
  output: A Cloud SQL DB instance data to cloud storage bucket by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, cloudsql, data-exfiltration, T1567-exfiltration-to-Cloud-Storage]

- rule: GCP Cloud SQL database instance deleted
  desc: Detect when a Cloud SQL DB instance has been deleted.
  condition: is_cloudsql_service and al.method.name="cloudsql.instances.delete"
  output: A Cloud SQL DB instance has been deleted by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, cloudsql, impact, T1485-data-destruction]

- rule: GCP Cloud SQL database instance modified or created
  desc: Detect when a Cloud SQL DB instance has been modified or created.
  condition: is_cloudsql_service and (al.method.name="cloudsql.instances.update" or al.method.name="cloudsql.instances.create" or al.method.name="cloudsql.instances.patch")
  output: A Cloud SQL DB instance has been modified or created by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, cloudsql, compliance]


- rule: GCP Bucket configured to be public
  desc: Detect when access on a GCP Bucket granted to the public internet.
  condition: is_gcs_service and al.authorization.permissions intersects ("storage.buckets.setIamPolicy") and al.bind.actions intersects("ADD") and is_binded_delta_to_public
  output: A GCP bucket access granted to be public by user=%al.principal %al.authorization.permissions %al.bind.members %al.resource.locations
  priority: CRITICAL
  source: auditlogs
  tags: [GCP, buckets, compliance]


- rule: GCP Bucket objects configured to be public
  desc: Detect when access on a GCP Bucket objects granted to the public internet.
  condition: is_gcs_service and al.authorization.permissions intersects ("storage.objects.setIamPolicy") and al.bind.actions intersects("ADD") and is_binded_delta_to_public
  output: A GCP bucket objects access granted to be public by user=%al.principal %al.authorization.permissions %al.bind.members
  priority: CRITICAL
  source: auditlogs
  tags: [GCP, buckets, objects, compliance]

- rule: GCP Bucket enumerated
  desc: Detect deletion of a GCS bucket.
  condition: is_gcs_service and al.method.name="storage.buckets.list"
  output: GCS buckets has been listed to user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, buckets, TA0007-discovery, T1083-file-and-directory-discovery]
  
- rule: GCP Bucket deleted
  desc: Detect deletion of a GCS bucket.
  condition: is_gcs_service and al.method.name="storage.buckets.delete"
  output: A GCS bucket has been deleted by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, buckets, mitre_data_destruction]

- rule: GCP Bucket updated
  desc: Detect when an administrative change to a GCS Bucket has been made.
  condition: is_gcs_service and al.method.name="storage.buckets.update"
  output: A GCS bucket has been updated by user=%al.principal callerip=%al.callerip resourceMeta=%al.meta authorizationResourceMeta=%al.authorization.resources authorizationPermissionMeta=%al.authorization.permissions useragent=%al.useragent service=%al.service.name method=%al.method.name zones=%al.resource.locations
  priority: NOTICE
  source: auditlogs
  tags: [GCP, buckets, compliance]

- rule: GCP Bucket permissions modified
  desc: Detect when permissions have changed on a GCS Bucket.
  condition: is_gcs_service and al.method.name="storage.setIamPermissions"
  output: A GCS bucket Iam policy has been changed by user=%al.principal %al.authorization.permissions
  priority: NOTICE
  source: auditlogs
  tags: [GCP, buckets, compliance]




- rule: GCP GCE Firewall rule modified
  desc: Detect when a firewall rule is created, modified or deleted.
  condition: is_compute_service and (al.method.name="v1.compute.firewalls.delete" or al.method.name="v1.compute.firewalls.patch" or al.method.name="v1.compute.firewalls.insert")
  output: A GCP GCE Firewall rule modified by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, Firewall, TA0005-defense-evasion, T1562-impair-defenses]



- rule: GCP WAF Network policy modified
  desc: Detect when a WAF Network policy is created, modified or deleted.
  condition: is_compute_service and (al.method.name="v1.compute.securityPolicies.delete" or al.method.name="v1.compute.securityPolicies.insert" or al.method.name="v1.compute.securityPolicies.patch")
  output: A GCP WAF network policy or waf rule modified by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, WAF, CloudArmor, TA0005-defense-evasion, T1562-impair-defenses]


- rule: GCP WAF rule modified
  desc: Detect when a WAF rule is created, modified or deleted.
  condition: is_compute_service and (al.method.name="v1.compute.securityPolicies.removeRule" or al.method.name="v1.compute.securityPolicies.addRule" or al.method.name="v1.compute.securityPolicies.patchRule")
  output: A GCP WAF network policy or waf rule modified by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, WAF, CloudArmor, TA0005-defense-evasion, T1562-impair-defenses]


- rule: GCP CloudArmor edge security service modified
  desc: Detect when a CloudArmor edge security created, modified or deleted.
  condition: is_compute_service and (al.method.name="compute.networkEdgeSecurityServices.delete" or al.method.name="compute.networkEdgeSecurityServices.create" or al.method.name="compute.networkEdgeSecurityServices.update")
  output: A GCP CloudArmor edge security modified by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, WAF, CloudArmor, TA0005-defense-evasion, T1562-impair-defenses]


- rule: GCP backendService deleted
  desc: Detect when a backendService deleted.
  condition: is_compute_service and (al.method.name="compute.backendServices.delete")
  output: A GCP backendService deleted by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, backendService, T1498-DOS]


- rule: GCP IAM serviceAccount created
  desc: Detect when a serviceAccount created.
  condition: is_iam_service and (al.method.name="google.iam.admin.v1.IAM.CreateServiceAccount)
  output: A GCP serviceAccount created by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, IAM, 	abuse-elevation-control-mechanism]


- rule: GCP IAM serviceAccount deleted
  desc: Detect when a serviceAccount deleted.
  condition: is_iam_service and (al.method.name="google.iam.admin.v1.IAM.DeleteServiceAccount")
  output: A GCP serviceAccount delete by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, IAM, 	abuse-elevation-control-mechanism]

- rule: GCP IAM serviceAccount modified
  desc: Detect when a serviceAccount modified.
  condition: is_iam_service and (al.method.name="google.iam.admin.v1.IAM.UpdateServiceAccount")
  output: A GCP serviceAccount delete by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, IAM, 	abuse-elevation-control-mechanism]


- rule: GCP IAM serviceAccount key created
  desc: Detect when a serviceAccount key created.
  condition: is_iam_service and (al.method.name="google.iam.admin.v1.IAM.CreateServiceAccountKey")
  output: A GCP serviceAccount delete by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, IAM, 	abuse-elevation-control-mechanism]


- rule: GCP IAM serviceAccount key deleted
  desc: Detect when a serviceAccount key created.
  condition: is_iam_service and (al.method.name="google.iam.admin.v1.IAM.DeleteServiceAccountKey")
  output: A GCP serviceAccount delete by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, IAM, 	abuse-elevation-control-mechanism]

- rule: GCP IAM custom role created
  desc: Detect when a IAM custom role created.
  condition: is_iam_service and (al.method.name="google.iam.admin.v1.IAM.CreateRole")
  output: A GCP IAM custom role created by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, IAM, 	abuse-elevation-control-mechanism]

- rule: GCP IAM custom role modified
  desc: Detect when a IAM custom role modified.
  condition: is_iam_service and (al.method.name="google.iam.admin.v1.IAM.UpdateRole")
  output: A GCP IAM custom role modified by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, IAM, 	abuse-elevation-control-mechanism]

- rule: GCP Pub/Sub topic deleted
  desc: Detect when a GCP Pub/Sub Subscribtion has been deleted. This could stop audit logs from being sent to Datadog.
  condition: is_pubsub_service and al.method.name="google.pubsub.v1.Publisher.DeleteTopic"
  output: A GCP Pub/Sub topic has been deleted by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, Pub/Sub, TA0005-defense-evasion, T1562-impair-defenses]

- rule: GCP Pub/Sub Subscriber modified
  desc: Detect when a GCP Pub/Sub Subscribtion has been deleted. This could stop audit logs from being sent to Datadog.
  condition: is_pubsub_service and (al.method.name="google.pubsub.v1.Subscriber.UpdateSubscription" or al.method.name="google.pubsub.v1.Subscriber.DeleteSubscription")
  output: A GCP Pub/Sub Subscribtion has been deleted by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, Pub/Sub, TA0005-defense-evasion, T1562-impair-defenses]


- rule: GCP logging sink modified
  desc: Detect when a GCP Pub/Sub Subscribtion has been deleted. This could stop audit logs from being sent to Datadog.
  condition: is_logging_service and (al.method.name="google.logging.v2.ConfigServiceV2.UpdateSink" or al.method.name="google.logging.v2.ConfigServiceV2.DeleteSink")
  output: A GCP Pub/Sub Subscribtion has been deleted by user=%al.principal
  priority: NOTICE
  source: auditlogs
  tags: [GCP, Sink, TA0005-defense-evasion, T1562-impair-defenses]




- rule: GCP Pod exec initiated
  desc: Detect when a principal execute commands on containers.
  condition: is_k8s_service and al.method.name="io.k8s.core.v1.pods.exec.create"
  output: An access granted for principal user=%al.principal callerip=%al.callerip test=%al.resource.type resourceMeta=%al.meta authorizationResourceMeta=%al.authorization.resources authorizationPermissionMeta=%al.authorization.permissions useragent=%al.useragent service=%al.service.name method=%al.method.name zones=%al.resource.locations
  priority: NOTICE
  source: auditlogs
  tags: [GCP, GKE, Pod, compliance]

- rule: GCP GKE secrets viewed
  desc: Detect when a GKE secret object being watched.
  condition: is_k8s_service and al.method.name="io.k8s.core.v1.secrets.watch"
  output: A secret object watched by principal user=%al.principal callerip=%al.callerip test=%al.resource.type resourceMeta=%al.meta authorizationResourceMeta=%al.authorization.resources authorizationPermissionMeta=%al.authorization.permissions useragent=%al.useragent service=%al.service.name method=%al.method.name zones=%al.resource.locations
  priority: NOTICE
  source: auditlogs
  tags: [GCP, GKE, Secret, compliance]




